global
  log stout
  chroot /var/lib/haproxy

  maxconn 50000
  daemon

defaults
  mode http
  log stout
  option dontlognull
  option httpclose
  option httplog
  option forwardfor
  option redispatch
  timeout connect 3000    # 3 seconds
  timeout client  300000  # 5 minutes
  timeout server  300000  # 5 minutes

frontend http_80
  bind *:80

  acl url_devserver path_beg /sockjs-node
  acl url_static path_beg /static /images /img /css
  acl url_static path_end .css .gif .html .jpg .js .png
  use_backend webserver if url_static url_devserver

  acl ethprovider_path path_beg /api/ethprovider
  use_backend ethprovider if ethprovider_path

  acl messaging_path path_beg /api/messaging
  use_backend nats if messaging_path

  acl api_path path_beg /api
  use_backend node if api_path

  default_backend webserver

backend ethprovider
  option httpchk HEAD / HTTP/1.1
  server webserver "$ETH_RPC_URL"

backend nats
  mode tcp
  option httpchk HEAD / HTTP/1.1
  server nats "$MESSAGING_URL"

backend node
  option httpchk HEAD / HTTP/1.1
  server node "$NODE_URL"

backend webserver
  option httpchk HEAD / HTTP/1.1
  server webserver "$WEBSERVER_URL"
